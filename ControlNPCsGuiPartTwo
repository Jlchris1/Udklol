-- Compact NPC Advanced Tools GUI with Tracker (Centered)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- CONFIG
local GUI_WIDTH = 200
local VOID_Y = -500
local LOOP_DELAY = 0.5
local TRACK_REFRESH = 0.3
local SEVERE_DISTANCE = 500

-- ScreenGui
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "NPC_AdvancedTools"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.Parent = PlayerGui

-- Main frame
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, GUI_WIDTH, 0, 28)
MainFrame.Position = UDim2.new(0.5, -GUI_WIDTH/2, 0.1, 0) -- Centered near top
MainFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true
MainFrame.Parent = ScreenGui

-- Toggle button
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(1,0,0,28)
ToggleButton.BackgroundColor3 = Color3.fromRGB(44,44,44)
ToggleButton.BorderSizePixel = 0
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.TextSize = 14
ToggleButton.TextColor3 = Color3.new(1,1,1)
ToggleButton.Text = "âš™ NPC Tools"
ToggleButton.Parent = MainFrame

-- ScrollingFrame for content
local ScrollFrame = Instance.new("ScrollingFrame")
ScrollFrame.Size = UDim2.new(1,0,1,-28)
ScrollFrame.Position = UDim2.new(0,0,0,28)
ScrollFrame.BackgroundColor3 = Color3.fromRGB(32,32,32)
ScrollFrame.BorderSizePixel = 0
ScrollFrame.CanvasSize = UDim2.new(0,0,0,0)
ScrollFrame.ScrollBarThickness = 6
ScrollFrame.Visible = false
ScrollFrame.Parent = MainFrame

local listLayout = Instance.new("UIListLayout")
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Padding = UDim.new(0,4)
listLayout.Parent = ScrollFrame

-- Helper UI functions
local function makeRow(text,width)
	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(1,-6,0,26)
	frame.BackgroundTransparency = 1
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(width or 0.7,0,1,0)
	btn.Position = UDim2.new(0,0,0,0)
	btn.BackgroundColor3 = Color3.fromRGB(58,58,58)
	btn.BorderSizePixel = 0
	btn.Font = Enum.Font.Gotham
	btn.TextSize = 13
	btn.TextColor3 = Color3.new(1,1,1)
	btn.Text = text
	btn.Parent = frame
	local loopBtn = Instance.new("TextButton")
	loopBtn.Size = UDim2.new(0.28,0,1,0)
	loopBtn.Position = UDim2.new(0.7,4,0,0)
	loopBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
	loopBtn.BorderSizePixel = 0
	loopBtn.Font = Enum.Font.Gotham
	loopBtn.TextSize = 11
	loopBtn.TextColor3 = Color3.new(1,1,1)
	loopBtn.Text = "Loop: Off"
	loopBtn.Parent = frame
	frame.Parent = ScrollFrame
	return btn, loopBtn
end

local function makeTextRow(defaultText)
	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(1,-6,0,26)
	frame.BackgroundTransparency = 1
	local box = Instance.new("TextBox")
	box.Size = UDim2.new(0.63,0,1,0)
	box.Position = UDim2.new(0,0,0,0)
	box.Text = defaultText
	box.PlaceholderText = defaultText
	box.BackgroundColor3 = Color3.fromRGB(50,50,50)
	box.TextColor3 = Color3.new(1,1,1)
	box.Font = Enum.Font.Gotham
	box.TextSize = 13
	box.ClearTextOnFocus = false
	box.Parent = frame
	local loopBtn = Instance.new("TextButton")
	loopBtn.Size = UDim2.new(0.34,0,1,0)
	loopBtn.Position = UDim2.new(0.63,4,0,0)
	loopBtn.BackgroundColor3 = Color3.fromRGB(80,80,40)
	loopBtn.Text = "Loop: Off"
	loopBtn.Font = Enum.Font.Gotham
	loopBtn.TextSize = 13
	loopBtn.TextColor3 = Color3.new(1,1,1)
	loopBtn.BorderSizePixel = 0
	loopBtn.Parent = frame
	frame.Parent = ScrollFrame
	return box, loopBtn
end

-- LOOP STATE
local loops = {}
local loopRunners = {}

local function getNPCs()
	local npcs = {}
	for _, hum in ipairs(Workspace:GetDescendants()) do
		if hum:IsA("Humanoid") then
			local model = hum.Parent
			if model and model:IsA("Model") and model:FindFirstChild("HumanoidRootPart") and not Players:GetPlayerFromCharacter(model) then
				table.insert(npcs, model)
			end
		end
	end
	return npcs
end

local function iterateParts(npc, fn)
	for _, p in ipairs(npc:GetDescendants()) do
		if p:IsA("BasePart") then pcall(function() fn(p) end) end
	end
end

-- NPC functions
local function setCurrentHPNaN(npc)
	local hum = npc:FindFirstChildOfClass("Humanoid")
	if hum then pcall(function() hum.Health = 0/0 end) end
end

local function healTick(npc, amt)
	local hum = npc:FindFirstChildOfClass("Humanoid")
	if hum then pcall(function() hum.Health = math.min(hum.MaxHealth or hum.Health, hum.Health + amt) end) end
end

local function setSpeed(npc,val)
	local hum = npc:FindFirstChildOfClass("Humanoid")
	if hum then pcall(function() hum.WalkSpeed = val end) end
end

local function setJump(npc,val)
	local hum = npc:FindFirstChildOfClass("Humanoid")
	if hum then pcall(function()
		if hum.JumpPower ~= nil then hum.JumpPower = val else hum.JumpHeight = val end
	end) end
end

-- UI Rows
local gravBox, gravLoopBtn = makeTextRow("Gravity Value")
local speedBox, speedLoopBtn = makeTextRow("NPC Speed")
local jumpBox, jumpLoopBtn = makeTextRow("NPC JumpPower")
local infBtn, infLoopBtn = makeRow("Set Current HP = 0/0")
local healBox, healBtn = makeTextRow("Heal per tick")
local trackerBtn, trackerLoop = makeRow("Toggle NPC Tracker")

-- Loop helpers
local function startLoop(key,func)
	if loopRunners[key] then return end
	loops[key]=true
	local co = coroutine.create(function()
		while loops[key] do
			for _,npc in ipairs(getNPCs()) do pcall(function() func(npc) end) end
			task.wait(LOOP_DELAY)
		end
		loopRunners[key]=nil
	end)
	loopRunners[key]=co
	coroutine.resume(co)
end
local function stopLoop(key) loops[key]=false end

local function attachLoopToggle(box,btn,key,func)
	btn.MouseButton1Click:Connect(function()
		loops[key]=not loops[key]
		btn.Text="Loop: "..(loops[key] and "On" or "Off")
		if loops[key] then startLoop(key,function(npc)
			local val=tonumber(box.Text)
			if val then func(npc,val) end
		end)
		else stopLoop(key) end
	end)
	box.FocusLost:Connect(function()
		local val = tonumber(box.Text)
		if val then
			for _,npc in ipairs(getNPCs()) do func(npc,val) end
		end
	end)
end

attachLoopToggle(gravBox,gravLoopBtn,"gravity",function(_,v) workspace.Gravity=v end)
attachLoopToggle(speedBox,speedLoopBtn,"speed",setSpeed)
attachLoopToggle(jumpBox,jumpLoopBtn,"jump",setJump)

-- Other buttons
infBtn.MouseButton1Click:Connect(function() for _,npc in ipairs(getNPCs()) do setCurrentHPNaN(npc) end end)
healBtn.MouseButton1Click:Connect(function() local amt=tonumber(healBox.Text) or 0 for _,npc in ipairs(getNPCs()) do healTick(npc,amt) end end)

-- Tracker
local trackedNPCs = {}
local trackerActive = false
local trackerConn = nil

local function addNPCToTracker(npc)
	if not npc or trackedNPCs[npc] then return end
	local hrp = npc:FindFirstChild("HumanoidRootPart")
	if not hrp then return end
	if hrp:FindFirstChild("NPCTracker") then return end
	local gui = Instance.new("BillboardGui")
	gui.Name = "NPCTracker"
	gui.Size = UDim2.new(0,180,0,40)
	gui.StudsOffset = Vector3.new(0,2,0)
	gui.AlwaysOnTop = true
	gui.Parent = hrp
	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1,-4,1,-4)
	label.Position = UDim2.new(0,2,0,2)
	label.BackgroundTransparency = 1
	label.TextColor3 = Color3.new(1,1,1)
	label.Font = Enum.Font.Code
	label.TextScaled = true
	label.Parent = gui
	trackedNPCs[npc] = {gui = gui, label = label}
end

local function removeNPCFromTracker(npc)
	local data = trackedNPCs[npc]
	if data and data.gui then pcall(function() data.gui:Destroy() end) end
	trackedNPCs[npc] = nil
end

local function updateTracker()
	local playerPos = player.Character and player.Character.PrimaryPart and player.Character.PrimaryPart.Position
	for npc, data in pairs(trackedNPCs) do
		if not npc.Parent or not npc:FindFirstChild("HumanoidRootPart") then removeNPCFromTracker(npc) end
		if data and data.label and npc.Parent then
			local hum = npc:FindFirstChildOfClass("Humanoid")
			local hrp = npc:FindFirstChild("HumanoidRootPart")
			local dist = 0
			if playerPos and hrp then dist = (hrp.Position - playerPos).Magnitude end
			if hum then
				data.label.Text = string.format("%s | HP: %.1f | Speed: %.1f | JP: %.1f | Dist: %.1f", npc.Name, hum.Health or 0, hum.WalkSpeed or 0, hum.JumpPower or hum.JumpHeight or 0, dist)
			end
		end
	end
end

local function scannerLoop()
	while trackerActive do
		for _, npc in ipairs(getNPCs()) do
			if not trackedNPCs[npc] then addNPCToTracker(npc) end
		end
		task.wait(TRACK_REFRESH)
	end
end

trackerBtn.MouseButton1Click:Connect(function()
	trackerActive = not trackerActive
	if trackerActive then
		if not trackerConn then
			trackerConn = RunService.Heartbeat:Connect(updateTracker)
		end
		task.spawn(scannerLoop)
	else
		if trackerConn then trackerConn:Disconnect() trackerConn=nil end
		for npc,_ in pairs(trackedNPCs) do removeNPCFromTracker(npc) end
	end
end)

-- Toggle GUI
local open=false
ToggleButton.MouseButton1Click:Connect(function()
	open=not open
	ScrollFrame.Visible=open
	local size=open and UDim2.new(0,GUI_WIDTH,0,300) or UDim2.new(0,GUI_WIDTH,0,28)
	TweenService:Create(MainFrame,TweenInfo.new(0.2,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{Size=size}):Play()
end)

print("[NPC_AdvancedTools] Centered compact tracker version loaded.")
