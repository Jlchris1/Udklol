-- KillAura_NPCVersion.lua
-- Targets NPCs (any model with a Humanoid + any BasePart acting as HRP)
-- GUI identical to previous version but simplified (no whitelist, no select, no tool resize)

--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

--// Config
local loopRate = 0.08
local hrpAdjustRate = 0.5

--// GUI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "KillAuraNPCGui"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 380, 0, 400)
mainFrame.Position = UDim2.new(1, -390, 0.5, -200)
mainFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
mainFrame.BackgroundTransparency = 0.05
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

--// UI Helpers
local function createLabel(parent, text, y)
	local lbl = Instance.new("TextLabel")
	lbl.Size = UDim2.new(1, -20, 0, 20)
	lbl.Position = UDim2.new(0, 10, 0, y)
	lbl.BackgroundTransparency = 1
	lbl.Text = text
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.TextColor3 = Color3.new(1,1,1)
	lbl.Font = Enum.Font.SourceSans
	lbl.TextSize = 16
	lbl.Parent = parent
	return lbl
end

local function createTextBox(parent, placeholder, y)
	local tb = Instance.new("TextBox")
	tb.Size = UDim2.new(1, -20, 0, 30)
	tb.Position = UDim2.new(0, 10, 0, y)
	tb.PlaceholderText = placeholder
	tb.Text = ""
	tb.BackgroundColor3 = Color3.fromRGB(230,230,230)
	tb.Parent = parent
	return tb
end

local function createToggle(parent, text, y)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1, -20, 0, 36)
	btn.Position = UDim2.new(0, 10, 0, y)
	btn.Text = text .. " : OFF"
	btn.BackgroundColor3 = Color3.fromRGB(200,200,200)
	btn.Parent = parent
	return btn
end

--// UI Elements
createLabel(mainFrame, "Kill-Aura / NPC Utilities", 6)
local rangeBox = createTextBox(mainFrame, "Kill aura range (studs)", 36)
local enableKillToggle = createToggle(mainFrame, "Enable Kill Aura (NPCs)", 76)
createLabel(mainFrame, "NPC HumanoidRootPart size adjust", 116)
local hrpSizeBox = createTextBox(mainFrame, "HRP size (e.g. 2)", 146)
local loopHrpAdjustToggle = createToggle(mainFrame, "Loop HRP adjust (NPCs)", 186)

--// State
local state = {
	killAuraEnabled = false,
	loopHrpAdjust = false,
	killAuraRange = 8,
	hrpSizeValue = 2,
}

--// Utilities
local function safeNumberFromTextBox(tb, fallback)
	local n = tonumber(tb.Text)
	if n and n > 0 then return n end
	return fallback
end

local function getMyHRP()
	local char = player.Character
	if not char then return nil end
	for _, obj in ipairs(char:GetChildren()) do
		if obj:IsA("BasePart") and obj.Name:lower():find("root") then
			return obj
		end
	end
	return char:FindFirstChildWhichIsA("BasePart")
end

--// Find NPC HRP
local function getNPCHRP(model)
	if not model or not model:IsA("Model") then return nil end
	local hum = model:FindFirstChildWhichIsA("Humanoid")
	if not hum then return nil end
	for _, part in ipairs(model:GetChildren()) do
		if part:IsA("BasePart") and part.Name:lower():find("root") then
			return part
		end
	end
	-- fallback: first BasePart if no “root” in name
	for _, part in ipairs(model:GetChildren()) do
		if part:IsA("BasePart") then
			return part
		end
	end
	return nil
end

--// Find all NPCs
local function getAllNPCs()
	local results = {}
	for _, obj in pairs(workspace:GetDescendants()) do
		if obj:IsA("Model") and obj:FindFirstChildWhichIsA("Humanoid") then
			-- exclude player characters
			if not Players:GetPlayerFromCharacter(obj) then
				table.insert(results, obj)
			end
		end
	end
	return results
end

--// Teleport Tools to Target NPC
local function teleportToolsToTarget(npc)
	local npcHRP = getNPCHRP(npc)
	if not npcHRP then return end
	local char = player.Character
	if not char then return end
	for _, tool in pairs(char:GetChildren()) do
		if tool:IsA("Tool") then
			for _, obj in pairs(tool:GetDescendants()) do
				if obj:IsA("Part") then
					pcall(function()
						obj.Massless = true
						obj.Position = npcHRP.Position
					end)
				end
			end
		end
	end
end

--// Kill Aura Loop
local killAuraRunning = false
local function killAuraLoop()
	killAuraRunning = true
	while state.killAuraEnabled do
		local range = state.killAuraRange or 8
		local myHRP = getMyHRP()
		if myHRP then
			for _, npc in pairs(getAllNPCs()) do
				local hrp = getNPCHRP(npc)
				if hrp and (hrp.Position - myHRP.Position).Magnitude <= range then
					teleportToolsToTarget(npc)
				end
			end
		end
		task.wait(loopRate)
	end
	killAuraRunning = false
end

--// HRP Adjust Loop (NPCs)
local hrpAdjustRunning = false
local function hrpAdjustLoop()
	hrpAdjustRunning = true
	while state.loopHrpAdjust do
		local sizeVal = state.hrpSizeValue or 2
		for _, npc in pairs(getAllNPCs()) do
			local hrp = getNPCHRP(npc)
			if hrp then
				pcall(function()
					hrp.Size = Vector3.new(sizeVal, sizeVal, sizeVal)
					hrp.CanCollide = false
				end)
			end
		end
		task.wait(hrpAdjustRate)
	end
	hrpAdjustRunning = false
end

--// Toggle Helper
local function setToggle(btn, enabled)
	if enabled then
		btn.BackgroundColor3 = Color3.fromRGB(120,200,120)
		btn.Text = btn.Text:match("^[^:]+") .. " : ON"
	else
		btn.BackgroundColor3 = Color3.fromRGB(200,200,200)
		btn.Text = btn.Text:match("^[^:]+") .. " : OFF"
	end
end

--// GUI Button Events
enableKillToggle.MouseButton1Click:Connect(function()
	state.killAuraEnabled = not state.killAuraEnabled
	setToggle(enableKillToggle, state.killAuraEnabled)
	if state.killAuraEnabled and not killAuraRunning then
		state.killAuraRange = safeNumberFromTextBox(rangeBox, state.killAuraRange)
		task.spawn(killAuraLoop)
	end
end)

rangeBox.FocusLost:Connect(function()
	state.killAuraRange = safeNumberFromTextBox(rangeBox, state.killAuraRange)
end)

loopHrpAdjustToggle.MouseButton1Click:Connect(function()
	state.loopHrpAdjust = not state.loopHrpAdjust
	setToggle(loopHrpAdjustToggle, state.loopHrpAdjust)
	if state.loopHrpAdjust and not hrpAdjustRunning then
		state.hrpSizeValue = safeNumberFromTextBox(hrpSizeBox, state.hrpSizeValue)
		task.spawn(hrpAdjustLoop)
	end
end)

hrpSizeBox.FocusLost:Connect(function()
	state.hrpSizeValue = safeNumberFromTextBox(hrpSizeBox, state.hrpSizeValue)
end)

--// Hide/Show Toggle
local hideToggle = Instance.new("TextButton")
hideToggle.Name = "HideToggle"
hideToggle.Size = UDim2.new(0, 140, 0, 36)
hideToggle.Position = UDim2.new(1, -540, 0.5, -260)
hideToggle.Text = "Hide/Show KillAura"
hideToggle.BackgroundColor3 = Color3.fromRGB(170,170,170)
hideToggle.Parent = screenGui
hideToggle.MouseButton1Click:Connect(function()
	mainFrame.Visible = not mainFrame.Visible
end)

print("NPC KillAura GUI loaded successfully.")
