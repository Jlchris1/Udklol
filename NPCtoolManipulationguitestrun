-- NPC_KillAura_Compact.lua (Final Version, GUI Resized & Fixed Hide/Show)
-- Compact, mobile-friendly GUI: KillAura + Attach Kill Aura + Attach Target + Kill All + Root HRP Adjuster

--// Services
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

--// Config
local loopRate = 0.08
local rapidTargetRate = 0.01
local hrpAdjustRate = 0.5
local buttonHeight = 22 -- Thinner buttons
local textBoxHeight = 22

--// GUI Setup
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NPCKillAuraGuiCompact"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 240, 0, 360)
mainFrame.Position = UDim2.new(0.5, 0, 0.55, 0)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
mainFrame.BackgroundTransparency = 0.05
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

-- Hide/Show toggle above the GUI
local hideToggle = Instance.new("TextButton")
hideToggle.Size = UDim2.new(0, 120, 0, buttonHeight)
hideToggle.Position = UDim2.new(0.5, -60, 0.55, -200)
hideToggle.Text = "Hide/Show KillAura"
hideToggle.BackgroundColor3 = Color3.fromRGB(170,170,170)
hideToggle.Parent = screenGui
local guiVisible = true
hideToggle.MouseButton1Click:Connect(function()
	guiVisible = not guiVisible
	mainFrame.Visible = guiVisible
end)

--// UI Helpers
local function createLabel(parent, text, y)
	local lbl = Instance.new("TextLabel")
	lbl.Size = UDim2.new(1, -10, 0, 16)
	lbl.Position = UDim2.new(0, 5, 0, y)
	lbl.BackgroundTransparency = 1
	lbl.Text = text
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	lbl.TextColor3 = Color3.new(1,1,1)
	lbl.Font = Enum.Font.SourceSans
	lbl.TextSize = 14
	lbl.Parent = parent
	return lbl
end

local function createTextBox(parent, placeholder, y, width)
	local tb = Instance.new("TextBox")
	tb.Size = UDim2.new(width or 1, -10, 0, textBoxHeight)
	tb.Position = UDim2.new(0, 5, 0, y)
	tb.PlaceholderText = placeholder
	tb.Text = ""
	tb.BackgroundColor3 = Color3.fromRGB(230,230,230)
	tb.Parent = parent
	return tb
end

local function createToggle(parent, text, y)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1, -10, 0, buttonHeight)
	btn.Position = UDim2.new(0, 5, 0, y)
	btn.Text = text .. " : OFF"
	btn.BackgroundColor3 = Color3.fromRGB(200,200,200)
	btn.Parent = parent
	return btn
end

local function createButton(parent, text, y)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1, -10, 0, buttonHeight)
	btn.Position = UDim2.new(0, 5, 0, y)
	btn.Text = text
	btn.BackgroundColor3 = Color3.fromRGB(180,180,250)
	btn.Parent = parent
	return btn
end

--// UI Elements
local yPos = 6
createLabel(mainFrame, "Kill-Aura / NPC Utilities", yPos) yPos += 20

local rangeBox = createTextBox(mainFrame, "Kill aura range (studs)", yPos, 0.48)
local attachRangeBox = createTextBox(mainFrame, "Attach aura range", yPos, 0.48)
attachRangeBox.Position = UDim2.new(0.52, 5, 0, yPos)
yPos += textBoxHeight + 4

local enableKillToggle = createToggle(mainFrame, "Enable Kill Aura (NPCs)", yPos) yPos += buttonHeight + 4
local enableAttachKillToggle = createToggle(mainFrame, "Enable Attach Kill Aura", yPos) yPos += buttonHeight + 4

createLabel(mainFrame, "NPC Root Size Adjust", yPos) yPos += 18
local hrpSizeBox = createTextBox(mainFrame, "Root size (e.g. 2)", yPos) yPos += textBoxHeight + 4
local loopHrpAdjustToggle = createToggle(mainFrame, "Loop Root Adjust (NPCs)", yPos) yPos += buttonHeight + 4

local targetAllToggle = createToggle(mainFrame, "Target All NPCs", yPos) yPos += buttonHeight + 4
local attachToolButton = createButton(mainFrame, "Attach Tool (Shirt Tools)", yPos) yPos += buttonHeight + 4
local attachTargetToggle = createToggle(mainFrame, "Attach Target NPCs", yPos) yPos += buttonHeight + 4
local killAllToggle = createToggle(mainFrame, "Kill All (Equipped Tools)", yPos) yPos += buttonHeight + 4
local unattachButton = createButton(mainFrame, "Unattach Tools", yPos) yPos += buttonHeight + 4

--// State
local state = {
	killAuraEnabled = false,
	attachKillAuraEnabled = false,
	loopHrpAdjust = false,
	targetAllNPCs = false,
	attachTarget = false,
	killAllEnabled = false,
	killAuraRange = 8,
	attachAuraRange = 8,
	hrpSizeValue = 2,
}

--// Utilities
local function safeNumberFromTextBox(tb, fallback)
	local n = tonumber(tb.Text)
	if n and n > 0 then return n end
	return fallback
end

local function getMyHRP()
	local char = player.Character
	if not char then return nil end
	return char:FindFirstChild("HumanoidRootPart")
end

local function getNPCHRP(model)
	if not model or not model:IsA("Model") then return nil end
	local hum = model:FindFirstChildOfClass("Humanoid")
	if not hum then return nil end
	return model:FindFirstChild("HumanoidRootPart")
end

local function getAllNPCs()
	local results = {}
	for _, obj in pairs(workspace:GetDescendants()) do
		if obj:IsA("Model") and obj:FindFirstChildOfClass("Humanoid") and not Players:GetPlayerFromCharacter(obj) then
			table.insert(results, obj)
		end
	end
	return results
end

local function teleportShirtToolsToTarget(npc)
	local npcHRP = getNPCHRP(npc)
	if not npcHRP then return end
	local char = player.Character
	if not char then return end
	local shirt = char:FindFirstChild("Shirt") or char:FindFirstChildOfClass("Humanoid")
	if not shirt then return end
	for _, tool in pairs(shirt:GetChildren()) do
		if tool:IsA("Tool") then
			for _, obj in pairs(tool:GetDescendants()) do
				if obj:IsA("BasePart") then
					pcall(function() obj.Massless = true obj.Position = npcHRP.Position end)
				end
			end
		end
	end
end

local function teleportEquippedToolsToNPC(npc)
	local npcHRP = getNPCHRP(npc)
	if not npcHRP then return end
	local char = player.Character
	if not char then return end
	for _, tool in pairs(char:GetChildren()) do
		if tool:IsA("Tool") and tool.Parent == char then
			local handle = tool:FindFirstChild("Handle")
			if handle then pcall(function() handle.Massless = true handle.Position = npcHRP.Position end) end
		end
	end
end

--// Loops
local killAuraRunning, attachKillAuraRunning, killAllRunning, targetAllRunning, attachTargetRunning, hrpAdjustRunning = false, false, false, false, false, false

local function killAuraLoop()
	killAuraRunning = true
	while state.killAuraEnabled do
		local myHRP = getMyHRP()
		if myHRP then
			for _, npc in ipairs(getAllNPCs()) do
				local hrp = getNPCHRP(npc)
				if hrp and (hrp.Position - myHRP.Position).Magnitude <= state.killAuraRange then
					teleportEquippedToolsToNPC(npc)
					task.wait(0.01)
				end
			end
		end
		task.wait(loopRate)
	end
	killAuraRunning = false
end

local function attachKillAuraLoop()
	attachKillAuraRunning = true
	while state.attachKillAuraEnabled do
		local myHRP = getMyHRP()
		if myHRP then
			for _, npc in ipairs(getAllNPCs()) do
				local hrp = getNPCHRP(npc)
				if hrp and (hrp.Position - myHRP.Position).Magnitude <= state.attachAuraRange then
					teleportShirtToolsToTarget(npc)
					task.wait(0.01)
				end
			end
		end
		task.wait(loopRate)
	end
	attachKillAuraRunning = false
end

local function killAllLoop()
	killAllRunning = true
	while state.killAllEnabled do
		for _, npc in ipairs(getAllNPCs()) do
			teleportEquippedToolsToNPC(npc)
			task.wait(0.01)
		end
		task.wait(loopRate)
	end
	killAllRunning = false
end

local function targetAllLoop()
	targetAllRunning = true
	while state.targetAllNPCs do
		for _, npc in ipairs(getAllNPCs()) do
			teleportShirtToolsToTarget(npc)
			task.wait(0.01)
		end
		task.wait(loopRate)
	end
	targetAllRunning = false
end

local function attachTargetLoop()
	attachTargetRunning = true
	while state.attachTarget do
		for _, npc in ipairs(getAllNPCs()) do
			teleportShirtToolsToTarget(npc)
			task.wait(0.01)
		end
		task.wait(loopRate)
	end
	attachTargetRunning = false
end

local function hrpAdjustLoop()
	hrpAdjustRunning = true
	while state.loopHrpAdjust do
		local sizeVal = state.hrpSizeValue
		for _, npc in ipairs(getAllNPCs()) do
			local root = npc:FindFirstChild("HumanoidRootPart")
			if root then
				pcall(function()
					root.Size = Vector3.new(sizeVal, sizeVal, sizeVal)
					root.CanCollide = false
				end)
			end
		end
		task.wait(hrpAdjustRate)
	end
	hrpAdjustRunning = false
end

--// Toggle helper
local function setToggle(btn, enabled)
	if enabled then
		btn.BackgroundColor3 = Color3.fromRGB(120,200,120)
		btn.Text = btn.Text:match("^[^:]+").." : ON"
	else
		btn.BackgroundColor3 = Color3.fromRGB(200,200,200)
		btn.Text = btn.Text:match("^[^:]+").." : OFF"
	end
end

--// Connections
enableKillToggle.MouseButton1Click:Connect(function()
	state.killAuraEnabled = not state.killAuraEnabled
	setToggle(enableKillToggle, state.killAuraEnabled)
	if state.killAuraEnabled and not killAuraRunning then
		state.killAuraRange = safeNumberFromTextBox(rangeBox, state.killAuraRange)
		task.spawn(killAuraLoop)
	end
end)

enableAttachKillToggle.MouseButton1Click:Connect(function()
	state.attachKillAuraEnabled = not state.attachKillAuraEnabled
	setToggle(enableAttachKillToggle, state.attachKillAuraEnabled)
	if state.attachKillAuraEnabled and not attachKillAuraRunning then
		state.attachAuraRange = safeNumberFromTextBox(attachRangeBox, state.attachAuraRange)
		task.spawn(attachKillAuraLoop)
	end
end)

rangeBox.FocusLost:Connect(function()
	state.killAuraRange = safeNumberFromTextBox(rangeBox, state.killAuraRange)
end)
attachRangeBox.FocusLost:Connect(function()
	state.attachAuraRange = safeNumberFromTextBox(attachRangeBox, state.attachAuraRange)
end)

loopHrpAdjustToggle.MouseButton1Click:Connect(function()
	state.loopHrpAdjust = not state.loopHrpAdjust
	setToggle(loopHrpAdjustToggle, state.loopHrpAdjust)
	if state.loopHrpAdjust and not hrpAdjustRunning then
		state.hrpSizeValue = safeNumberFromTextBox(hrpSizeBox, state.hrpSizeValue)
		task.spawn(hrpAdjustLoop)
	end
end)

hrpSizeBox.FocusLost:Connect(function()
	state.hrpSizeValue = safeNumberFromTextBox(hrpSizeBox, state.hrpSizeValue)
end)

targetAllToggle.MouseButton1Click:Connect(function()
	state.targetAllNPCs = not state.targetAllNPCs
	setToggle(targetAllToggle, state.targetAllNPCs)
	if state.targetAllNPCs and not targetAllRunning then task.spawn(targetAllLoop) end
end)

attachToolButton.MouseButton1Click:Connect(function()
	local char = player.Character
	if char then
		local shirt = char:FindFirstChild("Shirt") or char:FindFirstChildOfClass("Humanoid")
		if shirt then
			for _, tool in pairs(char:GetChildren()) do
				if tool:IsA("Tool") then tool.Parent = shirt end
			end
		end
	end
end)

attachTargetToggle.MouseButton1Click:Connect(function()
	state.attachTarget = not state.attachTarget
	setToggle(attachTargetToggle, state.attachTarget)
	if state.attachTarget and not attachTargetRunning then task.spawn(attachTargetLoop) end
end)

killAllToggle.MouseButton1Click:Connect(function()
	state.killAllEnabled = not state.killAllEnabled
	setToggle(killAllToggle, state.killAllEnabled)
	if state.killAllEnabled and not killAllRunning then task.spawn(killAllLoop) end
end)

unattachButton.MouseButton1Click:Connect(function()
	local char = player.Character
	if not char then return end
	local containers = {char:FindFirstChild("Shirt"), char:FindFirstChildOfClass("Humanoid")}
	for _, container in pairs(containers) do
		if container then
			for _, tool in pairs(container:GetChildren()) do
				if tool:IsA("Tool") then tool.Parent = char end
			end
		end
	end
	for _, tool in pairs(char:GetChildren()) do if tool:IsA("Tool") then tool.Parent = char end end
end)

print("NPC KillAura Compact GUI loaded - Resized frame, thinner buttons, Hide/Show fixed.")
