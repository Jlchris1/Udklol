-- NPC Control GUI (Fast Detection + Compact Fling Version)

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- CONFIG
local LOOP_DELAY = 0.5
local GUI_WIDTH = 200

-- Live NPC cache
local NPCs = {}

-- Helper: determines if a model is an NPC
local function isNPC(model)
	if not model:IsA("Model") then return false end
	if Players:GetPlayerFromCharacter(model) then return false end
	local hum = model:FindFirstChildOfClass("Humanoid")
	local hrp = model:FindFirstChild("HumanoidRootPart")
	return hum and hrp
end

-- Populate NPCs initially
for _,desc in ipairs(workspace:GetDescendants()) do
	if desc:IsA("Humanoid") then
		local model = desc.Parent
		if isNPC(model) then
			NPCs[model] = true
		end
	end
end

-- Detect new/removed NPCs in real time
workspace.DescendantAdded:Connect(function(obj)
	if obj:IsA("Humanoid") then
		local model = obj.Parent
		if isNPC(model) then
			NPCs[model] = true
		end
	end
end)

workspace.DescendantRemoving:Connect(function(obj)
	if obj:IsA("Humanoid") then
		local model = obj.Parent
		if NPCs[model] then
			NPCs[model] = nil
		end
	end
end)

-- GUI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "NPCControlGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.Parent = PlayerGui

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, GUI_WIDTH, 0, 30)
MainFrame.Position = UDim2.new(1, -GUI_WIDTH - 10, 0, 60)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true
MainFrame.Parent = ScreenGui

local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(1,0,0,30)
ToggleButton.BackgroundColor3 = Color3.fromRGB(44,44,44)
ToggleButton.BorderSizePixel = 0
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.TextSize = 14
ToggleButton.TextColor3 = Color3.new(1,1,1)
ToggleButton.Text = "â˜° NPC Controls"
ToggleButton.Parent = MainFrame

local Options = Instance.new("Frame")
Options.Size = UDim2.new(1,0,0,220)
Options.Position = UDim2.new(0,0,0,30)
Options.BackgroundColor3 = Color3.fromRGB(32,32,32)
Options.BorderSizePixel = 0
Options.Visible = false
Options.Parent = MainFrame

-- Helper UI functions
local function makeRow(y)
	local row = Instance.new("Frame")
	row.Size = UDim2.new(1, -8, 0, 28)
	row.Position = UDim2.new(0, 4, 0, y)
	row.BackgroundTransparency = 1
	row.Parent = Options
	return row
end

local function makeActionButton(parent,text)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0.65,0,1,0)
	btn.Position = UDim2.new(0,0,0,0)
	btn.BackgroundColor3 = Color3.fromRGB(58,58,58)
	btn.BorderSizePixel = 0
	btn.Font = Enum.Font.Gotham
	btn.TextSize = 13
	btn.TextColor3 = Color3.new(1,1,1)
	btn.Text = text
	btn.Parent = parent
	return btn
end

local function makeSmallToggle(parent)
	local tog = Instance.new("TextButton")
	tog.Size = UDim2.new(0.32,0,1,0)
	tog.Position = UDim2.new(0.67,4,0,0)
	tog.BackgroundColor3 = Color3.fromRGB(40,40,40)
	tog.BorderSizePixel = 0
	tog.Font = Enum.Font.Gotham
	tog.TextSize = 11
	tog.TextColor3 = Color3.new(1,1,1)
	tog.Text = "Loop: Off"
	tog.Parent = parent
	return tog
end

-- GUI Rows
local y = 6
local killRow = makeRow(y); y=y+34
local KillBtn = makeActionButton(killRow,"Kill NPCs")
local KillLoop = makeSmallToggle(killRow)

local psRow = makeRow(y); y=y+34
local PSBtn = makeActionButton(psRow,"PlatformStand")
local PSLoop = makeSmallToggle(psRow)

local sitRow = makeRow(y); y=y+34
local SitBtn = makeActionButton(sitRow,"Sit NPCs")
local SitLoop = makeSmallToggle(sitRow)

local anchorRow = makeRow(y); y=y+34
local AnchorBtn = makeActionButton(anchorRow,"Anchor NPCs")
local AnchorLoop = makeSmallToggle(anchorRow)

local flingRow = makeRow(y); y=y+34
local FlingBox = Instance.new("TextBox")
FlingBox.Size=UDim2.new(0.55,0,1,0)
FlingBox.Position=UDim2.new(0,0,0,0)
FlingBox.PlaceholderText="Power"
FlingBox.BackgroundColor3=Color3.fromRGB(50,50,50)
FlingBox.TextColor3=Color3.new(1,1,1)
FlingBox.Text="200"
FlingBox.BorderSizePixel=0
FlingBox.Font=Enum.Font.Gotham
FlingBox.TextSize=13
FlingBox.Parent=flingRow

local FlingBtn = Instance.new("TextButton")
FlingBtn.Size = UDim2.new(0.42,-4,1,0)
FlingBtn.Position = UDim2.new(0.55,4,0,0)
FlingBtn.BackgroundColor3 = Color3.fromRGB(100,50,50)
FlingBtn.Text="Fling"
FlingBtn.Font=Enum.Font.Gotham
FlingBtn.TextSize=13
FlingBtn.TextColor3=Color3.new(1,1,1)
FlingBtn.BorderSizePixel=0
FlingBtn.Parent=flingRow

local FlingLoopToggle = makeSmallToggle(flingRow)
FlingLoopToggle.Position = UDim2.new(0.55,70,0,0)

-- Logic
local loops = {kill=false,ps=false,sit=false,anchor=false,fling=false}
local loopRunners = {}

local function iterateHumanoidParts(npc,fn)
	for _,p in ipairs(npc:GetDescendants()) do
		if p:IsA("BasePart") then
			pcall(function() fn(p) end)
		end
	end
end

local function killNPC(npc)
	local hum = npc:FindFirstChildOfClass("Humanoid")
	if hum then
		pcall(function()
			hum.Health = 100
			task.wait(0.05)
			hum:TakeDamage(math.huge)
		end)
	end
end

local function enablePlatformStand(npc)
	local hum = npc:FindFirstChildOfClass("Humanoid")
	if hum then pcall(function() hum.PlatformStand = true end) end
end

local function makeSit(npc)
	local hum = npc:FindFirstChildOfClass("Humanoid")
	if hum then pcall(function() hum.Sit = true end) end
end

local anchoredNPCs = {}
local function toggleAnchor(npc)
	if anchoredNPCs[npc] then
		iterateHumanoidParts(npc,function(p) p.Anchored=false end)
		anchoredNPCs[npc]=nil
	else
		iterateHumanoidParts(npc,function(p) p.Anchored=true end)
		anchoredNPCs[npc]=true
	end
end

local function flingNPC(npc,power)
	local hrp = npc:FindFirstChild("HumanoidRootPart")
	local localHRP = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if not hrp or not localHRP then return end
	local dir = (hrp.Position - localHRP.Position).Unit
	local velocity = dir * power + Vector3.new(0, power * 0.3, 0)
	iterateHumanoidParts(npc, function(p)
		p.Velocity = velocity
	end)
end

-- Fast Loop System
local function startLoop(key,action)
	if loopRunners[key] then return end
	loops[key] = true
	local co = coroutine.create(function()
		while loops[key] do
			for npc,_ in pairs(NPCs) do
				if npc.Parent then pcall(function() action(npc) end) end
			end
			task.wait(LOOP_DELAY)
		end
		loopRunners[key] = nil
	end)
	loopRunners[key] = co
	coroutine.resume(co)
end

local function stopLoop(key)
	loops[key] = false
end

-- Button actions
KillBtn.MouseButton1Click:Connect(function()
	for npc,_ in pairs(NPCs) do killNPC(npc) end
end)
PSBtn.MouseButton1Click:Connect(function()
	for npc,_ in pairs(NPCs) do enablePlatformStand(npc) end
end)
SitBtn.MouseButton1Click:Connect(function()
	for npc,_ in pairs(NPCs) do makeSit(npc) end
end)
AnchorBtn.MouseButton1Click:Connect(function()
	for npc,_ in pairs(NPCs) do toggleAnchor(npc) end
end)
FlingBtn.MouseButton1Click:Connect(function()
	local s = tonumber(FlingBox.Text) or 200
	for npc,_ in pairs(NPCs) do flingNPC(npc,s) end
end)

-- Loop toggles
local function linkLoop(button,key,action)
	button.MouseButton1Click:Connect(function()
		loops[key]=not loops[key]
		button.Text="Loop: "..(loops[key] and "On" or "Off")
		if loops[key] then startLoop(key,action) else stopLoop(key) end
	end)
end

linkLoop(KillLoop,"kill",killNPC)
linkLoop(PSLoop,"ps",enablePlatformStand)
linkLoop(SitLoop,"sit",makeSit)
linkLoop(AnchorLoop,"anchor",toggleAnchor)
linkLoop(FlingLoopToggle,"fling",function(n)
	local s=tonumber(FlingBox.Text) or 200
	flingNPC(n,s)
end)

-- GUI toggle
local open=false
ToggleButton.MouseButton1Click:Connect(function()
	open=not open
	local targetSize=open and UDim2.new(0,GUI_WIDTH,0,270) or UDim2.new(0,GUI_WIDTH,0,30)
	TweenService:Create(MainFrame,TweenInfo.new(0.22,Enum.EasingStyle.Sine,Enum.EasingDirection.Out),{Size=targetSize}):Play()
	task.wait(0.08)
	Options.Visible=open
end)

print("[NPCControlGUI] Fast detection version loaded.")
